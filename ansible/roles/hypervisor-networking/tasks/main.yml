---
- name: Assert required hypervisor networking variables are defined
  ansible.builtin.assert:
    that:
      - net_phys_iface is defined
      - net_bridge_name is defined
      - net_server_vlan is defined
      - net_allowed_vlans is defined
    fail_msg: >
      Missing required variables. Define in host vars:
      net_phys_iface, net_bridge_name, net_server_vlan, net_allowed_vlans

- name: Normalize allowed VLAN list and ensure server VLAN is included
  ansible.builtin.set_fact:
    net_allowed_vlans_normalized: >-
      {{ (net_allowed_vlans + [net_server_vlan]) | map('int') | list | unique }}

- name: Sort allowed VLANs
  ansible.builtin.set_fact:
    net_allowed_vlans_sorted: "{{ net_allowed_vlans_normalized | sort }}"

- name: Ensure /etc/systemd/network exists
  ansible.builtin.file:
    path: /etc/systemd/network
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Generate timestamp for networkd config backup
  ansible.builtin.command: date +%Y%m%d%H%M%S
  register: hypervisor_networkd_backup_ts
  changed_when: false

- name: Backup /etc/systemd/network before cleanup
  ansible.builtin.shell: |
    set -euo pipefail
    tar -C /etc/systemd -cf /etc/systemd/network.backup.hypervisor.{{ hypervisor_networkd_backup_ts.stdout }}.tar network
  args:
    executable: /bin/bash
  changed_when: true

- name: Define approved networkd config files
  ansible.builtin.set_fact:
    networkd_approved_files:
      - "/etc/systemd/network/10-{{ net_bridge_name }}.netdev"
      - "/etc/systemd/network/21-{{ net_bridge_name }}.{{ net_server_vlan }}.netdev"
      - "/etc/systemd/network/20-{{ net_bridge_name }}.network"
      - "/etc/systemd/network/22-{{ net_bridge_name }}.{{ net_server_vlan }}.network"
      - "/etc/systemd/network/30-{{ net_phys_iface }}.network"

- name: Find existing networkd config files
  ansible.builtin.find:
    paths: /etc/systemd/network
    patterns:
      - "*.network"
      - "*.netdev"
      - "*.link"
    file_type: file
  register: networkd_existing_files

- name: Remove non-approved networkd config files
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ networkd_existing_files.files }}"
  when: item.path not in networkd_approved_files

- name: Stage bridge netdev
  ansible.builtin.template:
    src: bridge.netdev.j2
    dest: "/etc/systemd/network/10-{{ net_bridge_name }}.netdev"
    owner: root
    group: root
    mode: "0644"
  register: bridge_netdev_result

- name: Stage bridge network
  ansible.builtin.template:
    src: bridge.network.j2
    dest: "/etc/systemd/network/20-{{ net_bridge_name }}.network"
    owner: root
    group: root
    mode: "0644"
  register: bridge_network_result

- name: Stage server VLAN netdev
  ansible.builtin.template:
    src: vlan.netdev.j2
    dest: "/etc/systemd/network/21-{{ net_bridge_name }}.{{ net_server_vlan }}.netdev"
    owner: root
    group: root
    mode: "0644"
  register: vlan_netdev_result

- name: Stage server VLAN network (DHCP on VLAN subif)
  ansible.builtin.template:
    src: vlan.network.j2
    dest: "/etc/systemd/network/22-{{ net_bridge_name }}.{{ net_server_vlan }}.network"
    owner: root
    group: root
    mode: "0644"
  register: vlan_network_result

- name: Stage physical NIC network (enslave to bridge)
  ansible.builtin.template:
    src: phys.network.j2
    dest: "/etc/systemd/network/30-{{ net_phys_iface }}.network"
    owner: root
    group: root
    mode: "0644"
  register: phys_network_result

- name: Set hypervisor networking change fact
  ansible.builtin.set_fact:
    hypervisor_networking_changed: >-
      {{ bridge_netdev_result.changed
         or bridge_network_result.changed
         or vlan_netdev_result.changed
         or vlan_network_result.changed
         or phys_network_result.changed }}

- name: Display staged networkd paths
  ansible.builtin.debug:
    msg:
      - "Staged: /etc/systemd/network/10-{{ net_bridge_name }}.netdev"
      - "Staged: /etc/systemd/network/20-{{ net_bridge_name }}.network"
      - "Staged: /etc/systemd/network/21-{{ net_bridge_name }}.{{ net_server_vlan }}.netdev"
      - "Staged: /etc/systemd/network/22-{{ net_bridge_name }}.{{ net_server_vlan }}.network"
      - "Staged: /etc/systemd/network/30-{{ net_phys_iface }}.network"
      - "Apply is {{ 'enabled' if (hypervisor_networking_apply | bool) else 'disabled' }}."

- name: Apply systemd-networkd for bridge changes
  ansible.builtin.systemd:
    name: systemd-networkd
    enabled: true
    state: restarted
  when:
    - hypervisor_networking_apply | bool
  tags:
    - risky

- name: Wait briefly for networkd to settle
  ansible.builtin.pause:
    seconds: 10
  when:
    - hypervisor_networking_apply | bool
  tags:
    - risky
